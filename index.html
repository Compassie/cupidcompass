<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cupid Compass</title>
    <style>
        :root {
            --gold: #d4af37;
            --heart-red: #ff3b3b;
        }

        html, body {
            margin: 0; padding: 0;
            background: #000;
            height: 100%; width: 100%;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center; 
        }

        .bg-input { background-image: url('input-bg.png'); background-size: cover; background-position: center; }
        .bg-compass { background-image: url('compass-bg.png'); background-size: cover; background-position: center; }

        /* Initial State: Compass and Reset Icon are hidden via CSS */
        #compass-viewport, #reset-icon { 
            display: none; 
        }

        /* Input Screen UI */
        #input-screen {
            display: flex; 
            flex-direction: column;
            z-index: 100;
            padding: 30px;
            border: 1px solid var(--gold);
            background: rgba(0, 0, 0, 0.9);
            width: 80%; max-width: 320px;
            border-radius: 50px 50px 10px 10px;
            text-align: center;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }

        .input-group {
            display: flex; align-items: center; margin-bottom: 12px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
        }
        label { width: 80px; text-align: left; font-size: 0.7rem; color: var(--gold); text-transform: uppercase; }
        input { flex: 1; padding: 10px; border: none; background: transparent; color: #fff; outline: none; }

        #confirm-btn {
            margin-top: 15px; padding: 12px;
            background: transparent; color: var(--gold);
            border: 1px solid var(--gold); border-radius: 25px;
            text-transform: uppercase; font-weight: bold; cursor: pointer;
        }

        /* Compass Viewport */
        #compass-viewport {
            position: absolute;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            justify-content: center;
            align-items: center; 
        }

        .compass-wrap {
            position: relative;
            width: 140vw; height: 140vw;
            max-width: 80vh; max-height: 80vh; 
        }

        .compass-layer {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100%; height: 100%;
            object-fit: contain;
        }

        #cupid-needle {
            z-index: 5;
            will-change: transform;
            transition: transform 0.4s cubic-bezier(0.1, 0.3, 0.3, 1);
        }

        #ornament-layer {
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transform-origin: 50% 9.1543%; /* Heart anchor */
        }

        /* Heartbeat Animation */
        @keyframes heartbeat {
            0% { transform: translate(-50%, -50%) scale(1); filter: brightness(1) drop-shadow(0 0 0px var(--heart-red)); opacity: 0; }
            30% { transform: translate(-50%, -50%) scale(1.15); filter: brightness(1.8) drop-shadow(0 0 20px var(--heart-red)); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.05); filter: brightness(1.4) drop-shadow(0 0 10px var(--heart-red)); opacity: 0.8; }
            70% { transform: translate(-50%, -50%) scale(1.2); filter: brightness(2) drop-shadow(0 0 30px var(--heart-red)); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); filter: brightness(1) drop-shadow(0 0 0px var(--heart-red)); opacity: 0; }
        }

        .beating {
            animation: heartbeat 0.8s ease-in-out 3;
        }

        .target-locked {
            filter: drop-shadow(0 0 8px var(--gold)) brightness(1.1);
        }

        /* Reset Icon - Ensure it stays on top */
        #reset-icon {
            position: fixed; 
            bottom: 30px; 
            right: 30px;
            width: 50px; 
            height: 50px; 
            z-index: 200; 
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-input">

    <div id="input-screen">
        <p style="font-style: italic; color: var(--gold); margin-bottom: 20px;">❦ Guide by Your Heart ❦</p>
        <div class="input-group">
            <label>City</label>
            <input type="text" id="city-input" placeholder="Enter city name...">
        </div>
        <div style="font-size: 0.6rem; color: var(--gold); margin: 5px;">— OR —</div>
        <div class="input-group">
            <label>Lat</label><input type="number" id="lat" step="any">
        </div>
        <div class="input-group">
            <label>Lng</label><input type="number" id="lng" step="any">
        </div>
        <button id="confirm-btn" onclick="handleStart()">Begin</button>
    </div>

    <div id="compass-viewport">
        <div class="compass-wrap">
            <img id="compass-base" class="compass-layer" src="compass-base.png">
            <img id="cupid-needle" class="compass-layer" src="cupid-needle.png">
            <img id="ornament-layer" class="compass-layer" src="ornament.png">
        </div>
    </div>

    <img id="reset-icon" src="icon.png" onclick="showInput()">

    <script>
        const needle = document.getElementById('cupid-needle');
        const ornament = document.getElementById('ornament-layer');
        const viewport = document.getElementById('compass-viewport');
        const inputScreen = document.getElementById('input-screen');
        const resetIcon = document.getElementById('reset-icon');

        let targetLat, targetLng, userLat, userLon, currentRotation = 0, lockState = false, smoothedHeading = 0;

        window.onload = () => {
            const savedLat = localStorage.getItem('mucha_lat');
            const savedLng = localStorage.getItem('mucha_lng');
            if (savedLat) {
                document.getElementById('lat').value = savedLat;
                document.getElementById('lng').value = savedLng;
            }
            // Logic to ensure clean start
            inputScreen.style.display = 'flex';
            viewport.style.display = 'none';
            resetIcon.style.display = 'none';
        };

        function startGPS() {
            navigator.geolocation.watchPosition((pos) => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
            }, null, { enableHighAccuracy: true });
        }

        async function handleStart() {
            const city = document.getElementById('city-input').value;
            if (city) {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`);
                    const data = await res.json();
                    if (data.length > 0) {
                        targetLat = parseFloat(data[0].lat);
                        targetLng = parseFloat(data[0].lon);
                    } else { alert("City not found."); return; }
                } catch (e) { alert("Network error."); return; }
            } else {
                targetLat = parseFloat(document.getElementById('lat').value);
                targetLng = parseFloat(document.getElementById('lng').value);
            }
            if (isNaN(targetLat)) return alert("Please specify a location.");
            localStorage.setItem('mucha_lat', targetLat);
            localStorage.setItem('mucha_lng', targetLng);

            // Toggle Screens
            inputScreen.style.display = 'none';
            viewport.style.display = 'flex';
            resetIcon.style.display = 'block'; // Make button appear
            document.body.className = 'bg-compass';
            
            startGPS();
            initSensors();
        }

        function showInput() {
            inputScreen.style.display = 'flex';
            viewport.style.display = 'none';
            resetIcon.style.display = 'none'; // Hide button on input page
            document.body.className = 'bg-input';
        }

        async function initSensors() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                const res = await DeviceOrientationEvent.requestPermission();
                if (res === 'granted') window.addEventListener('deviceorientation', updateRotation, true);
            } else {
                window.addEventListener('deviceorientation', updateRotation, true);
            }
        }

        function updateRotation(event) {
            let rawHeading = event.webkitCompassHeading || (360 - event.alpha);
            let filterAlpha = 0.15;
            let hDiff = rawHeading - smoothedHeading;
            if (hDiff > 180) hDiff -= 360;
            if (hDiff < -180) hDiff += 360;
            smoothedHeading += filterAlpha * hDiff;

            if (!userLat) return;
            const bearing = getBearing(userLat, userLon, targetLat, targetLng);
            let targetRotation = bearing - smoothedHeading;
            let rotDiff = targetRotation - (currentRotation % 360);
            if (rotDiff > 180) rotDiff -= 360;
            if (rotDiff < -180) rotDiff += 360;
            currentRotation += rotDiff;

            needle.style.transform = `translate(-50%, -50%) rotate(${currentRotation}deg)`;

            const checkAngle = Math.abs(currentRotation % 360);
            if (checkAngle <5 || checkAngle > 355) {
                if (!lockState) {
                    ornament.classList.add('beating');
                    needle.classList.add('target-locked');
                    if ("vibrate" in navigator) navigator.vibrate([100, 100, 100, 100, 100]);
                    lockState = true;
                }
            } else {
                if (lockState) {
                    ornament.classList.remove('beating');
                    needle.classList.remove('target-locked');
                    lockState = false;
                }
            }
        }

        function getBearing(lat1, lon1, lat2, lon2) {
            const φ1 = lat1 * Math.PI / 180, φ2 = lat2 * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const y = Math.sin(Δλ) * Math.cos(φ2);
            const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }
    </script>
</body>
</html>
